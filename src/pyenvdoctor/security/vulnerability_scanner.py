import requests
from packaging.version import parse
from typing import List, Dict
from ..core.models import PythonInstallation

class VulnerabilityScanner:
    def __init__(self):
        self.db_url = "https://pypi.org/pypi/{package}/json"
        self.cache = {}

    def scan_installation(self, install: PythonInstallation) -> Dict[str, List]:
        results = {}
        for pkg, version in install.packages.items():
            vulns = self._check_package(pkg, version)
            if vulns:
                results[pkg] = vulns
        return results

    def _check_package(self, pkg: str, version: str):
        try:
            response = requests.get(self.db_url.format(package=pkg))
            data = response.json()
            return [
                v for v in data.get('vulnerabilities', [])
                if parse(version) <= parse(v['fixed_in'])
            ]
        except Exception:
            return []
